/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved.
 * http://www.jaspersoft.com.
 *
 * Unless you have purchased a commercial license agreement from Jaspersoft,
 * the following license terms apply:
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

define(["require","exports","module","jquery","underscore","../converter/inputControlsToViewModelConverter","../converter/getControlPaginationOptionsByControlIdAndType","../rest/enum/restParamsEnum","../predicate/isQueryControl","../converter/getControlsPaginationOptionsByControlId"],function(e,t,n){function r(e,t){return u(e)||i(e,t)||o()}function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function i(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,o=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return n}}function u(e){if(Array.isArray(e))return e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(n,!0).forEach(function(t){f(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=e("jquery"),v=e("underscore"),C=e("../converter/inputControlsToViewModelConverter"),y=e("../converter/getControlPaginationOptionsByControlIdAndType"),h=e("../rest/enum/restParamsEnum"),g=e("../predicate/isQueryControl"),O=e("../converter/getControlsPaginationOptionsByControlId"),S=function(e,t,n,r){return e.reduce(function(e,o){if(g(o)){var i=p({},e,f({},o.id,O({controlId:o.id,controls:t}).map(n)));return void 0!==r&&r(i[o.id]),i}return e},{})},m=function(e){var t=e.controlId,n=e.value,r=e.controls,o=e.selection,i=v.reduce(r,function(e,r){var i={};return i=r.id===t?{value:n.length>0?n:[h.NOTHING_SUBSTITUTION_VALUE]}:{value:o[r.id]||[],select:h.SELECTED_VALUES},p({},e,f({},r.id,p({masterDependencies:r.masterDependencies||[],slaveDependencies:r.slaveDependencies||[]},i)))},{});return O({controlId:t,controls:i})},I=function(e,t){var n=v.pluck(e,"id"),r=v.keys(t),o={},i=v.intersection(n,r);return i.length>0&&i.forEach(function(e){o[e]=t[e]}),o},E=function(){function e(t){a(this,e),f(this,"inputControlsService",void 0),this.inputControlsService=t.inputControlsService}return c(e,[{key:"fetchInputControlsInitialState",value:function(e,t){var n=this;return this.inputControlsService.getInputControlsMetadata(e).then(function(r){if(r){var o=C.metadataToViewModelConverter(r);return n.fetchInitialInputControlsValuesByUriAndStructure(e,o,t)}return d.Deferred().resolve(r)})}},{key:"fetchInitialInputControlsValuesByUri",value:function(e,t,n){return this.fetchInitialInputControlsValuesByUriAndStructure(e,t,n)}},{key:"fetchInputControlsOptionsBySelectionAndUri",value:function(e,t,n){var r=n.reduce(function(e,t){return p({},e,f({},t.id,t))},{}),o=v.map(e,function(t,n){return y(n,r[n].type,{value:t&&0===t.length?[h.NOTHING_SUBSTITUTION_VALUE]:e[n]||[]})}),i=S(n,r,function(t){return p({},t,{value:e[t.name]||[]})});return this.fetchInputControlsOptionsByPaginatedValuesOptionsAndUri({paginationOptions:o,paginationOptionsPerControl:i,uri:t}).then(function(e){return d.Deferred().resolve(e,o,i)})}},{key:"fetchInputControlsValuesOnControlSelectionChange",value:function(e){var t=e.controlId,n=e.value,r=e.uri,o=e.structure,i=e.selection,u=e.initialSelectedValues,a=n.reduce(function(e,t){return p({},e,f({},t,!0))},{}),l=o.reduce(function(e,t){return p({},e,f({},t.id,t))},{}),c=m({controlId:t,value:n,selection:i,controls:l}),s=u[t]&&u[t].every(function(e){return a[e.value]});return this.fetchInputControlsOptionsByPaginatedValuesOptionsAndUri({paginationOptions:c,uri:r}).then(function(e){var t=e.inputControlState,n=c.reduce(function(e,n){if(n.select===h.SELECTED_VALUES){var r=[];if(s&&u[n.name])r=u[n.name].map(function(e){return e.value});else{var o=t.find(function(e){return e.id===n.name});if(o){var i=o.options.find(function(e){return e.selected});r=i?[i.value]:[]}}return p({},e,f({},n.name,r))}return e},{});return d.Deferred().resolve(e,n,c)})}},{key:"fetchInitialInputControlsValuesByUriAndStructure",value:function(e,t,n){var o=this,i=I(t,n),u=t.map(function(e){return y(e.id,e.type,i[e.id]?{value:i[e.id]}:{select:h.SELECTED_VALUES})}),a=this.inputControlsService.getInputControlsPaginatedValues(e,u),l=this.inputControlsService.getInputControlsSelectedValues(e);return d.when(a,l).then(function(n,u){var a=r(u,1),l=a[0],c=n instanceof Array?n[0]:n,s={};s=v.isEmpty(i)?l?l.selectedValue.reduce(function(e,t){return p({},e,f({},t.id,t.options||[]))},{}):{}:c.inputControlState.reduce(function(e,t){var n=t.options?t.options.filter(function(e){return e.selected}).map(function(e){return v.omit(e,"selected")}):[{label:t.value,value:t.value}];return p({},e,f({},t.id,n||[]))},{});var C=t.reduce(function(e,t){return p({},e,f({},t.id,i[t.id]?p({},t,{value:i[t.id]}):p({},t,{select:h.SELECTED_VALUES})))},{}),y=S(t,C,function(e){return i[e.name]?p({},e,{value:i[e.name]}):p({},e,{select:h.SELECTED_VALUES})},function(t){o.inputControlsService.setCacheValueForControlPaginatedValues(e,t,c)});return d.Deferred().resolve({structure:t,selection:s,paginationOptionsPerControl:y,paginatedValuesResponse:c})})}},{key:"fetchInputControlsOptionsByPaginatedValuesOptionsAndUri",value:function(e){var t=this,n=e.paginationOptions,r=e.paginationOptionsPerControl,o=void 0===r?{}:r,i=e.uri;return this.inputControlsService.clearCache(),this.inputControlsService.getInputControlsPaginatedValues(i,n).then(function(e){return n.forEach(function(n){var r=n.name;o[r]&&t.inputControlsService.setCacheValueForControlPaginatedValues(i,o[r],e)}),e})}}]),e}();n.exports=E});