/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved.
 * http://www.jaspersoft.com.
 *
 * Unless you have purchased a commercial license agreement from Jaspersoft,
 * the following license terms apply:
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

define(["require","exports","module","jquery","../namespace/namespace","underscore","request","./rest/InputControlsService","./rest/InputControlsServiceWithCache","./service/InputControlsReportViewerService","../core/core.ajax.utils","./controls.core","./controls.datatransfer","./controls.viewmodel","./controls.components","jquery.urldecoder"],function(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o.apply(this,arguments)}function i(e){return a(e)||l(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function l(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function a(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}var c=e("jquery"),u=e("../namespace/namespace"),p=u.JRS,d=e("underscore"),h=e("request"),v=e("./rest/InputControlsService"),f=e("./rest/InputControlsServiceWithCache"),g=e("./service/InputControlsReportViewerService"),C=e("../core/core.ajax.utils"),w=C.showErrorPopup;e("./controls.core"),e("./controls.datatransfer"),e("./controls.viewmodel"),e("./controls.components"),e("jquery.urldecoder");var S=function(e,t){var n=e&&e.inputControlState?e.inputControlState:[],r=!0;return n.forEach(function(e){var n=t[e.id];n&&n.get("error")&&n.set({error:null}),e.error&&(n.set({error:e.error}),r=!1)}),r};!function(e,t,n){t.extend(n,{Controller:n.Base.extend({constructor:function(r){var o=this;t.bindAll(this,"getViewModel","resetControlsToSelection","validate"),this.inputControlsService=new f({inputControlsService:new v({request:h})}),this.inputControlsReportViewerService=new g({inputControlsService:this.inputControlsService}),this.viewModel=r&&r.viewModel?r.viewModel:new n.ViewModel,this.initialize(r),n.ignore("reportoptions:selection:changed"),n.listen({"viewmodel:selection:changed":function(){o._onViewModelSelectionChange.apply(o,arguments)},"reportoptions:selection:changed":function(){o._onReportOptionsSelectionChanged.apply(o,arguments)}}),n.getController=t.bind(function(){return this},this),e(document).trigger("controls:initialized",[this.getViewModel()])},_onViewModelSelectionChange:function(s,l,a,c){var u=this,p=this.getViewModel(),d=p.getControls();if(a&&c){var h=this.inputControlsReportViewerService.fetchInputControlsValuesOnControlSelectionChange({controlId:l,value:a,uri:this.dataUri,structure:p.structure,selection:p.get("selection"),initialSelectedValues:p.controlsOptions.initialSelectedValues}).then(function(t,n,r){var o=r.map(function(e){var t=e.name;return d[t].fetch(u.dataUri,r)});return e.when.apply(e,i(o)).then(function(){return e.Deferred().resolve(n,t)})}).then(function(e,n){e=o({},e,r({},l,a)),t.each(e,function(e,t){d[t].set({values:e})}),S(n,d)}).catch(function(t){var n=d[l];return n.set({values:n.selection}),w(t.responseJSON.message),e.Deferred().reject(t)});n.Utils.showLoadingDialogOn(h,null,!0)}else l&&this.viewModel.controls[l].set({selection:a},!0)},_onReportOptionsSelectionChanged:function(r,o){var s=this,l=o.reportOption,a=o.previousReportOption,c=this.viewModel,u=c.getControls();this.dataUri=l&&l.uri||this.dataUri;var p=this.inputControlsReportViewerService.fetchInitialInputControlsValuesByUri(this.dataUri,c.structure,o.selectedData).then(function(n){var r=n.selection,o=n.paginatedValuesResponse,l=n.paginationOptionsPerControl,a=t.map(l,function(e,t){var n=u[t];return n.updateSelectionOnOptionChange&&n.updateSelectionOnOptionChange(r[t]||[]),n.fetch(s.dataUri,e)});return e.when.apply(e,i(a)).then(function(){return e.Deferred().resolve(r,o)})}).then(function(e,n){t.each(e,function(e,t){u[t].set({values:e.map(function(e){return e.value})})}),S(n,u)}).catch(function(t){return w(t.responseJSON.message),n.reportOptions.set({selection:a},!0),e.Deferred().reject(t)});n.Utils.showLoadingDialogOn(p,null,!0)},initialize:function(e){this.dataUri=e.reportOptionUri||e.reportUri},fetchAndSetInputControlsState:function(t){var r=this,o=this.inputControlsReportViewerService.fetchInputControlsInitialState(this.dataUri,t).then(function(t){if(t){r.viewModel.set({structure:t.structure,controlsOptions:{dataUri:r.dataUri,inputControlsService:r.inputControlsService,initialSelectedValues:t.selection,paginatedValuesOptions:t.paginationOptionsPerControl,paginatedValuesResponse:t.paginatedValuesResponse}});var n=r.getViewModel(),o=n.getControls();S(t.paginatedValuesResponse,o)}return e.Deferred().resolve(t)});return n.Utils.showLoadingDialogOn(o,null,!0),o},getViewModel:function(){return this.viewModel},resetControlsToSelection:function(n){var r=this,o=this.getViewModel(),s=o.getControls();return n||(n=o.get("selection")),this.inputControlsReportViewerService.fetchInputControlsOptionsBySelectionAndUri(n,this.dataUri,o.structure).then(function(t,n,o){var l=n.map(function(e){return s[e.name].fetch(r.dataUri,o[e.name]||n)});return e.when.apply(e,i(l)).then(function(){return t})}).then(function(e){S(e,s),t.each(s,function(e,t){var r,o=n[t];r=o?{values:o}:{error:null,values:void 0,selection:void 0},e.reset(r)})})},validate:function(){var t=this.getViewModel(),r=t.getControls(),o=t.get("selection"),i=e.Deferred();return this.inputControlsReportViewerService.fetchInputControlsOptionsBySelectionAndUri(o,this.dataUri,t.structure).then(function(e){var t=S(e,r);return t?i.resolve(t):i.reject()}),n.Utils.showLoadingDialogOn(i,null,!0),i}})})}(c,d,p.Controls),n.exports=p.Controls});